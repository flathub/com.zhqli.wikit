app-id: com.zhqli.wikit
runtime: org.gnome.Platform
# TODO: upgrade after tauri supports new webkit2ttk
runtime-version: '42'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node16
command: wikit
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --talk-name=org.a11y.Bus
  - --talk-name=org.gtk.vfs.*
  - --filesystem=xdg-run/gvfsd

build-options:
  append-path: /app/lib/sdk/rust-nightly/bin:/usr/lib/sdk/node16/bin

modules:
  - name: rust
    buildsystem: simple
    cleanup:
      - '*'
    build-commands:
      - cd rust && ./install.sh --prefix=/app/lib/sdk/rust-nightly --without=rust-docs
        --without=rust-docs-json-preview --disable-ldconfig --verbose
      - cd rust-std-wasm32 && ./install.sh --prefix=/app/lib/sdk/rust-nightly --without=rust-docs
        --without=rust-docs-json-preview --disable-ldconfig --verbose
      - cd rust-src && ./install.sh --prefix=/app/lib/sdk/rust-nightly --disable-ldconfig
        --verbose
    sources:
      - type: archive
        only-arches:
          - aarch64
        dest: rust
        url: https://static.rust-lang.org/dist/2023-02-16/rust-nightly-aarch64-unknown-linux-gnu.tar.xz
        sha256: 5393b4c7e95c2a3d01332282e6d20b0a8db0854f623897bfbed3bb7338a6fcb4
        x-checker-data:
          type: rust
          package: rust
          channel: nightly
          target: aarch64-unknown-linux-gnu
      - type: archive
        only-arches:
          - x86_64
        dest: rust
        url: https://static.rust-lang.org/dist/2023-02-16/rust-nightly-x86_64-unknown-linux-gnu.tar.xz
        sha256: e6d2aece6ef2bc7ff62eaf16d8db4c847f653c4633d616dd28866390755fdc16
        x-checker-data:
          type: rust
          package: rust
          channel: nightly
          target: x86_64-unknown-linux-gnu
      # Required by yew
      - type: archive
        dest: rust-std-wasm32
        url: https://static.rust-lang.org/dist/2023-02-16/rust-std-nightly-wasm32-unknown-unknown.tar.xz
        sha256: 4f92f7e44e2d614fe280e97cc83214dd9c2d2c8c622d3976afb38f2a8b9105c5
        x-checker-data:
          type: rust
          package: rust-std
          channel: nightly
          target: wasm32-unknown-unknown
      - type: archive
        dest: rust-src
        url: https://static.rust-lang.org/dist/2023-02-16/rust-src-nightly.tar.xz
        sha256: 4abda570899415e849ce7946a35b8af0f2923e6c7ecaff8246042a9a923576d8
        x-checker-data:
          type: rust
          package: rust-src
          channel: nightly
          target: '*'

  - name: wikit-cli
    buildsystem: simple
    build-options:
      env:
        CARGO_HOME: /run/build/wikit-cli/cargo
    build-commands:
      - cd cli && cargo --offline build --release
      - install -Dm755 target/release/wikit -t "${FLATPAK_DEST}/bin"
    sources:
      - type: git
        url: https://github.com/ikey4u/wikit
        commit: 352ccf2b8352fedf213f61c218ad05c32277f53b
        x-checker-data:
          type: anitya
          project-id: 326657
          tag-template: $version
        tag: 0.5.0
      - generated-sources.json

      # TODO: remove it after upstream update the lockfile
      - type: file
        path: Cargo.lock

  - name: wikit
    buildsystem: simple
    build-options:
      env:
        CARGO_HOME: /run/build/wikit/cargo
    build-commands:
      - cd desktop && cargo --offline tauri build --bundles none # No need to bundle
      - install -Dm755 target/release/wikit-desktop -t "${FLATPAK_DEST}/bin"
      - install -Dm644 desktop/tauri/app-icon.svg "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg"
    modules:
      - name: tauri
        buildsystem: simple
        cleanup:
          - '*'
        build-options:
          env:
            CARGO_HOME: /run/build/tauri/cargo
        build-commands:
          - cargo --offline install tauri-cli trunk
          - install -Dm755 "${CARGO_HOME}/bin/cargo-tauri" -t "${FLATPAK_DEST}/bin"
          - install -Dm755 "${CARGO_HOME}/bin/trunk" -t "${FLATPAK_DEST}/bin"
        sources:
          - generated-sources.json

      - name: dart-sass
        cleanup:
          - '*'
        buildsystem: simple
        build-commands:
          - install -D -m755 sass ${FLATPAK_DEST}/bin/sass
        sources:
          - type: archive
            url: https://github.com/sass/dart-sass/releases/download/1.58.1/dart-sass-1.58.1-linux-x64.tar.gz
            sha256: e7f9847ac8426a4a7f7a3bbd321159f155ef1c4b971a20d5b542365212345cf5
            only-arches:
              - x86_64
            x-checker-data:
              type: anitya
              project-id: 326670
              url-template: https://github.com/sass/dart-sass/releases/download/$version/dart-sass-$version-linux-x64.tar.gz
          - type: archive
            url: https://github.com/sass/dart-sass/releases/download/1.58.1/dart-sass-1.58.1-linux-arm64.tar.gz
            sha256: dc12bd4834ccf731ed007776780899d5d7b096bcf0f947e5a9c3643ad57f9015
            only-arches:
              - aarch64
            x-checker-data:
              type: anitya
              project-id: 326670
              url-template: https://github.com/sass/dart-sass/releases/download/$version/dart-sass-$version-linux-arm64.tar.gz

      - name: wasm-bindgen
        cleanup:
          - '*'
        buildsystem: simple
        build-commands:
          - install -D -m755 wasm-bindgen ${FLATPAK_DEST}/bin/wasm-bindgen
        sources:
          - type: archive
            url: https://github.com/rustwasm/wasm-bindgen/releases/download/0.2.84/wasm-bindgen-0.2.84-x86_64-unknown-linux-musl.tar.gz
            sha256: 55b4a591246cb69e983a6badd17e4a9d61712bbbed4b4c6c681b2e5dd76e61da
            only-arches:
              - x86_64
            x-checker-data:
              type: anitya
              project-id: 128315
              url-template: https://github.com/rustwasm/wasm-bindgen/releases/download/$version/wasm-bindgen-$version-x86_64-unknown-linux-musl.tar.gz
          - type: archive
            url: https://github.com/rustwasm/wasm-bindgen/releases/download/0.2.84/wasm-bindgen-0.2.84-aarch64-unknown-linux-gnu.tar.gz
            sha256: 033f13228cf7770ba0707ff90428f37b8216b449fbab369d186a213a2781ec32
            only-arches:
              - aarch64
            x-checker-data:
              type: anitya
              project-id: 128315
              url-template: https://github.com/rustwasm/wasm-bindgen/releases/download/$version/wasm-bindgen-$version-aarch64-unknown-linux-gnu.tar.gz
    sources:
      - type: git
        url: https://github.com/ikey4u/wikit
        commit: 352ccf2b8352fedf213f61c218ad05c32277f53b
        x-checker-data:
          type: anitya
          project-id: 326657
          tag-template: $version

        tag: 0.5.0
      - generated-sources.json

      # TODO: remove it after upstream update the lockfile
      - type: file
        path: Cargo.lock

  - name: metadata
    buildsystem: simple
    build-commands:
      - install -Dm644 com.zhqli.wikit.metainfo.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
      - install -Dm644 com.zhqli.wikit.desktop "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
    sources:
      - type: file
        path: com.zhqli.wikit.metainfo.xml
      - type: file
        path: com.zhqli.wikit.desktop
