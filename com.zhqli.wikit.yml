app-id: com.zhqli.wikit
runtime: org.gnome.Platform
# TODO: upgrade after tauri supports new webkit2ttk
runtime-version: '42'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node16
command: wikit
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
build-options:
  append-path: /app/lib/sdk/rust-nightly/bin:/usr/lib/sdk/node16/bin:/run/build/wikit/cargo/bin

modules:
  - name: rust
    buildsystem: simple
    cleanup:
      - /share/info
      - /share/man
    build-commands:
      - cd rust && ./install.sh --prefix=/app/lib/sdk/rust-nightly --without=rust-docs
        --without=rust-docs-json-preview --disable-ldconfig --verbose
      - cd rust-std-wasm32 && ./install.sh --prefix=/app/lib/sdk/rust-nightly --without=rust-docs
        --without=rust-docs-json-preview --disable-ldconfig --verbose
      - cd rust-src && ./install.sh --prefix=/app/lib/sdk/rust-nightly --disable-ldconfig
        --verbose
    sources:
      - type: archive
        only-arches:
          - aarch64
        dest: rust
        url: https://static.rust-lang.org/dist/2023-02-13/rust-nightly-aarch64-unknown-linux-gnu.tar.xz
        sha256: b9a940e363743b72c28d891938244e870a0e64d9bd28c9054729f4994c6399dd
        x-checker-data:
          type: rust
          package: rust
          channel: nightly
          target: aarch64-unknown-linux-gnu
      - type: archive
        only-arches:
          - x86_64
        dest: rust
        url: https://static.rust-lang.org/dist/2023-02-13/rust-nightly-x86_64-unknown-linux-gnu.tar.xz
        sha256: 4b21772bad60e79992d8a81405a0532744df65c93b50c9ed49bf6d3760f10835
        x-checker-data:
          type: rust
          package: rust
          channel: nightly
          target: x86_64-unknown-linux-gnu
      # Required by yew
      - type: archive
        dest: rust-std-wasm32
        url: https://static.rust-lang.org/dist/2023-02-13/rust-std-nightly-wasm32-unknown-unknown.tar.xz
        sha256: b6ce769e7ebea4fa0eef2330f9b8655662fbb4fe49064ff8993822c5dde6771a
        x-checker-data:
          type: rust
          package: rust-std
          channel: nightly
          target: wasm32-unknown-unknown
      - type: archive
        dest: rust-src
        url: https://static.rust-lang.org/dist/2023-02-13/rust-src-nightly.tar.xz
        sha256: 931d7b6d770da81991ed0b5a105d87204b3f8f245596ccab1eea44489b3c3d0b
        x-checker-data:
          type: rust
          package: rust-src
          channel: nightly
          target: '*'

  - name: dart-sass
    cleanup:
      - '*'
    buildsystem: simple
    build-commands:
      - install -D -m755 sass ${FLATPAK_DEST}/bin/sass
    sources:
      - type: archive
        url: https://github.com/sass/dart-sass/releases/download/1.58.0/dart-sass-1.58.0-linux-x64.tar.gz
        sha256: 4018e3b8cb66168bb38a54a2fca5b0ec83b74e47b01ce0d953338c3ed6fc9067
        only-arches:
          - x86_64
        x-checker-data:
          type: anitya
          project-id: 326670
          url-template: https://github.com/sass/dart-sass/releases/download/$version/dart-sass-$version-linux-x64.tar.gz
      - type: archive
        url: https://github.com/sass/dart-sass/releases/download/1.58.0/dart-sass-1.58.0-linux-arm64.tar.gz
        sha256: 957e6470f59dab62814aeaa12960e7169d05a41f32a1eaf98a58bf8c5c348c86
        only-arches:
          - aarch64
        x-checker-data:
          type: anitya
          project-id: 326670
          url-template: https://github.com/sass/dart-sass/releases/download/$version/dart-sass-$version-linux-arm64.tar.gz

  - name: wasm-bindgen
    cleanup:
      - '*'
    buildsystem: simple
    build-commands:
      - install -D -m755 wasm-bindgen ${FLATPAK_DEST}/bin/wasm-bindgen
    sources:
      - type: archive
        url: https://github.com/rustwasm/wasm-bindgen/releases/download/0.2.84/wasm-bindgen-0.2.84-x86_64-unknown-linux-musl.tar.gz
        sha256: 55b4a591246cb69e983a6badd17e4a9d61712bbbed4b4c6c681b2e5dd76e61da
        only-arches:
          - x86_64
        x-checker-data:
          type: anitya
          project-id: 128315
          url-template: https://github.com/rustwasm/wasm-bindgen/releases/download/$version/wasm-bindgen-$version-x86_64-unknown-linux-musl.tar.gz
      - type: archive
        url: https://github.com/rustwasm/wasm-bindgen/releases/download/0.2.84/wasm-bindgen-0.2.84-aarch64-unknown-linux-gnu.tar.gz
        sha256: 033f13228cf7770ba0707ff90428f37b8216b449fbab369d186a213a2781ec32
        only-arches:
          - aarch64
        x-checker-data:
          type: anitya
          project-id: 128315
          url-template: https://github.com/rustwasm/wasm-bindgen/releases/download/$version/wasm-bindgen-$version-aarch64-unknown-linux-gnu.tar.gz

  - name: wikit-cli
    buildsystem: simple
    build-options:
      env:
        CARGO_HOME: /run/build/wikit/cargo
    build-commands:
      - cd cli && cargo --offline build --release
      - install -Dm755 target/release/wikit -t "${FLATPAK_DEST}/bin"
    sources:
      - type: git
        url: https://github.com/ikey4u/wikit
        commit: 54224531004acc467b94a898c5915d30e0829812
        x-checker-data:
          type: anitya
          project-id: 326657
          tag-template: $version
      - generated-sources.json

      # TODO: remove it after upstream update the lockfile
      - type: file
        path: Cargo.lock

  - name: wikit
    buildsystem: simple
    build-options:
      env:
        CARGO_HOME: /run/build/wikit/cargo
    build-commands:
      - cargo --offline  install tauri-cli trunk
      - cd desktop && cargo --offline  tauri build --bundles none # No need to bundle into deb
      - install -Dm755 target/release/wikit-desktop -t "${FLATPAK_DEST}/bin"
      - install -Dm644 desktop/tauri/app-icon.svg "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg"
      - install -Dm644 com.zhqli.wikit.metainfo.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
      - install -Dm644 com.zhqli.wikit.desktop "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
    sources:
      - type: git
        url: https://github.com/ikey4u/wikit
        commit: 54224531004acc467b94a898c5915d30e0829812
        x-checker-data:
          type: anitya
          project-id: 326657
          tag-template: $version

      - type: file
        path: com.zhqli.wikit.metainfo.xml
      - type: file
        path: com.zhqli.wikit.desktop

      - generated-sources.json

      # TODO: remove it after upstream update the lockfile
      - type: file
        path: Cargo.lock
